---
title: "Cov(inc period, serial interval) in Tianjin"
author: "Jessica Stockdale"
date: "May 19, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(viridis)
library(tidyverse)
library(lubridate)
options(digits=3)
set.seed(3456)
```

## Tianjin

First, load in the data

```{r}
tdata=read.csv("data/Tianjin135cases_revised.csv",na.strings = "", stringsAsFactors = F)
tdata$symptom_onset=as.Date(tdata$symptom_onset, format = "%d/%m/%Y")
tdata$start_source=as.Date(tdata$start_source, format = "%d/%m/%Y")
tdata$end_source=as.Date(tdata$end_source,format = "%d/%m/%Y" )
tdata$confirm_date=as.Date(tdata$confirm_date,format = "%d/%m/%Y" )
tdata <- tdata[which(!is.na(tdata$symptom_onset)),]
names(tdata)[1] = "case_id"

tdata$Infection_source <- str_replace(tdata$Infection_source, pattern = "JN", replacement = "TJ")

```

We need to do some preprocessing. NOTE: This step involves assuming that, in each pair, the one who showed symptoms first was the infector. 

```{r}
tdata$Infection_source <- str_to_lower(tdata$Infection_source)
tdata$Infection_source <- str_trim(tdata$Infection_source)
tdata$Infection_source_dup <- tdata$Infection_source
tdata$Infection_source_dup <- str_replace_all(tdata$Infection_source_dup, pattern = "person", replacement = "individual")
tdata$Infection_source_dup <- str_replace(tdata$Infection_source_dup, 
                                          pattern = "coworker of a individual from wuhan",
                                          replacement = "coworker")


tdata <- mutate(tdata, source_group = case_when(!is.na(str_match(Infection_source_dup, "wuhan|hubei")) ~ "Wuhan and Hubei", #Priority 1
                                                  !is.na(str_match(Infection_source_dup, "mall|store|shopper|shopping")) ~ "Mall", #Priority 1
                                                  !is.na(str_match(Infection_source_dup, "family|relative|wife|mother|son|sister|daughter|brother|husband|duaghtor|whife|hunsband")) ~ "Relative", #Priority 2
                                                  !is.na(str_match(Infection_source_dup, "coworker|business|workplace|colleague|colleage")) ~ "Coworker", #Priority 2
                                                  !is.na(str_match(Infection_source_dup, "tj|patient")) ~ "Other relationship", #Priority 2
                                                  !is.na(str_match(Infection_source_dup, "train|travel|trip|hebei|dalian")) ~ "Other travel", #Priority 3
                                                  !is.na(str_match(Infection_source_dup, "unknown|unclear")) ~ "Unknown", #Priority 5
                                                  is.na(Infection_source_dup) ~ "Unknown", #Priority 5
                                                  T ~ "other")) #there should be none of these, so this is just a sanity check!  

#Remove the duplicated infection source column which is no longer necessary
tdata <- select(tdata, -Infection_source_dup)

#What is distribution of probably source of infection (grouped)?
table(tdata$source_group) 

mynodes <- tdata$case_id

mynodes <- str_to_lower(mynodes) 
tdata$case_id <- str_to_lower(tdata$case_id)

edges = data.frame(from=mynodes[9],to=mynodes[21],stringsAsFactors = F ) # i read this one manually 

for (id in 1:nrow(tdata)) {
tonode=tdata$case_id[id]
fromnodes=str_extract_all(tdata$Infection_source[id], "tj\\d+", simplify = T) #in lower case due to above early/late split on infection source
  if (length(fromnodes)>0) {
    for (k in 1:length(fromnodes)) {
      edges=rbind(edges, c(fromnodes[k], tonode))
    }
  }
}
head(edges)
edges=edges[-1,] #Remove the initial relationship we gave so it isn't duplicated
edges=edges[-which(is.na(edges[,1])),] # NAs arose from a few empty entries for Infection_source 

tdata_sympt <- select(tdata, case_id, symptom_onset)

names(tdata_sympt) <- str_replace(names(tdata_sympt), "case_id", "from")
undir_tdates <- left_join(edges, tdata_sympt, by = "from")
names(undir_tdates) <- str_replace(names(undir_tdates), "symptom_onset", "from_sympt_date")

# Repeat, but add the date of symptom onset for the caseID of the 'to' case
names(tdata_sympt) <- str_replace(names(tdata_sympt), "from", "to")
undir_tdates <- left_join(undir_tdates, tdata_sympt, by = "to")
names(undir_tdates) <- str_replace(names(undir_tdates), "symptom_onset", "to_sympt_date")

undir_tdates <- mutate(undir_tdates, earliest_sympt_onset = pmin(to_sympt_date, from_sympt_date, na.rm = T), 
                                   raw_serial_interval = to_sympt_date - from_sympt_date,   
                                   abs_serial_interval = abs(raw_serial_interval))

pos <- filter(undir_tdates, raw_serial_interval >= 0)
neg <- filter(undir_tdates, raw_serial_interval < 0)
onlyone <- filter(undir_tdates, is.na(raw_serial_interval)) 

names(neg)
names(neg)[1] <- "to"
names(neg)[2] <- "from"
names(neg)[3] <- "to_sympt_date"
names(neg)[4] <- "from_sympt_date"
names(neg)

undir_tdates <- bind_rows(pos, neg, onlyone)

undir_tdates$pto <- str_replace(undir_tdates$to, pattern = "tj", replacement = "")
undir_tdates$pto <- str_pad(undir_tdates$pto, width = 3, side = "left", pad = "0")

undir_tdates$pfrom <- str_replace(undir_tdates$from, pattern = "tj", replacement = "")
undir_tdates$pfrom <- str_pad(undir_tdates$pfrom, width = 3, side = "left", pad = "0")

undir_tdates <- mutate(undir_tdates, pairID = factor(paste("tj", pfrom, "-", "tj", pto, sep = "")))

rm(pos, neg, onlyone)

```

We also need to get the incubation periods

```{r}
tdata$end_source[which(is.na(tdata$end_source))]=tdata$symptom_onset[which(is.na(tdata$end_source))]  # if no end exposure: set to symptom onset 
tdata$end_source = pmin(tdata$end_source, tdata$symptom_onset) # if end exposure after onset, set to onset 
tdata$start_source[which(is.na(tdata$start_source))]= tdata$symptom_onset[which(is.na(tdata$start_source))] - 20 # if no start, set to symptom onset - 20

tdata$maxIncTimes=tdata$symptom_onset-tdata$start_source 
tdata$minIncTimes = tdata$symptom_onset-tdata$end_source

tdata$maxIncTimes = pmax(3, tdata$maxIncTimes)
tdata$minIncTimes = pmax(1, tdata$minIncTimes)

```

We want to make a data frame with a row for every suspected infector-infectee pair - and including the serial interval for this pair, and the incubation period of both infector and infectee. 

```{r}

tianjin.data <- data.frame(infector = undir_tdates$from, infectee = undir_tdates$to, serial.interval = undir_tdates$abs_serial_interval, inc.infector.min = tdata$minIncTimes[match(undir_tdates$from,tdata$case_id)], inc.infector.max = tdata$maxIncTimes[match(undir_tdates$from,tdata$case_id)], inc.infectee.min =  tdata$minIncTimes[match(undir_tdates$to,tdata$case_id)], inc.infectee.max = tdata$maxIncTimes[match(undir_tdates$to,tdata$case_id)])

```

There are some NAs at the end of this, which we filter out

```{r}

tianjin.data = tianjin.data[!is.na(tianjin.data$serial.interval),]

```


CC begins here. 

```{r}
tianjin.data$serial.interval = as.numeric(tianjin.data$serial.interval)
tianjin.data$Amean = 0.5*(tianjin.data$inc.infector.min + tianjin.data$inc.infector.max)
tianjin.data$Bmean = 0.5*(tianjin.data$inc.infectee.min + tianjin.data$inc.infectee.max)
library(ggplot2)
ggplot(data=tianjin.data, aes(x= serial.interval, y=Bmean, col=Amean) ) + geom_point() +   geom_smooth(method='lm')

ggplot(data=tianjin.data, aes(x= serial.interval, y=Amean, col=Bmean) ) + geom_point() +   geom_smooth(method='lm')
```
Interesting, looks like a mild correlation, positive between serial and B incubation, and negative with A incubation, which is strange..? 

```{r}

fit1 = lm(formula = serial.interval ~ Bmean, data = tianjin.data)
summary(fit1)
plot(fit1)

cov(tianjin.data$serial.interval,tianjin.data$Bmean) # 2.63
hpear =  cor.test(tianjin.data$serial.interval,tianjin.data$Bmean); hpear
hspear = cor.test(tianjin.data$serial.interval,tianjin.data$Bmean,method="spearman"); hspear
hkend= cor.test(tianjin.data$serial.interval,tianjin.data$Bmean,method = "kendall"); hkend

```

The portion of SI - incubation period that is negative is the portion asymp transmission and in this raw data it is high. However, we probably want to exclude really long IPs and SIs because they are unlikely to be direct samples from the distributions. let's try this. I find that the correlation is not sensitive to removing long SIs but it is sensitive to removing long B incubation periods. But this is a bit unfair -- naturally removing the largest mean values will make a difference.

What we could do is remove rows where we don't have a good estimate of min and max, so our mean incubation period for the infectee is not a good one. This removes quite a few rows, but is it justified, I think. 

```{r}
tjd = filter(tianjin.data, inc.infectee.min > 1 &  inc.infectee.max < 20 ) # only 16 rows left
tjd = filter(tianjin.data, inc.infectee.min > 1 | inc.infectee.max < 20 ) # NOTE OR works really well
tjd = filter(tianjin.data, inc.infectee.min > 1 ) # 
h = cor.test(tjd$serial.interval, tjd$Bmean, method = "spearman"); h
h = cor.test(tjd$serial.interval, tjd$Bmean); h
h = cor.test(tjd$serial.interval, tjd$Bmean, method="kendall"); h
```

The correlation is preserved but significance is lost (around 0.1 now)


Now, having estimated the SI and the incubation period gamma parameters in our various ways, we wish to sample from the joint distribution. Or from some joint distributions that can reflect the various estimates we have made. 




```{r}
library(lcmix)
# install.packages("lcmix", repos="http://R-Forge.R-project.org")

mysamps = rmvgamma(n=500, shape=c(2.5,3.75), rate=c(0.5,0.5), corr=matrix(c(1, 0.3, 0.3, 1), nrow = 2))
plot(mysamps[,1],mysamps[,2])
hist(mysamps[,1]-mysamps[,2],breaks = 30)
length(which(mysamps[,1]-mysamps[,2] <0))/nrow(mysamps)
```

Those are high numbers. We could use the shape, scale info for the incubation period and the mean, variance for the serial intervals, resampling and so on, to estimate this. I would like to know how this number depends on the covariance. It will also depend on the difference in means - if the means are too different, no matter what the covariance the fraction is high .. 
I will pick this up later. 


```{r}

```

